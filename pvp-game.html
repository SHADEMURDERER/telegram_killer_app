<!DOCTYPE html>
<html>
<head>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>
  <meta charset="UTF-8">
  <title>Gizmo PVP</title>
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/pvp-game.css">
</head>
<body>

<div id="pvp-container">
  <div id="pvp-status">Ожидание игроков...</div>
  
  <div class="player-info">
    <div class="player">
      <div class="player-color" id="player1-color"></div>
      <span id="player1-name">Вы</span>
    </div>
    <div class="player">
      <div class="player-color" id="player2-color"></div>
      <span id="player2-name">Соперник</span>
    </div>
  </div>
  
  <div id="progress-bar">
    <div id="progress-fill"></div>
    <div id="progress-pointer"></div>
  </div>
  
  <div id="pvp-result"></div>
  <button id="pvp-bet" onclick="placeBet()">Сделать ставку (50 золотых)</button>
</div>

<script src="scripts/main.js"></script>
<script src="scripts/pvp-game.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyC6EklCDD25kU_nuXyeh5mj9F24KECyYpM",
    databaseURL: "https://console.firebase.google.com/project/gizmo-27843/overview"
  };
  
  const app = firebase.initializeApp(firebaseConfig);
  window.db = firebase.getDatabase(app);
  // Ваши текущие переменные
  const currentPlayer = {
    id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id || 'anon_' + Math.random().toString(36).slice(2),
    name: window.Telegram?.WebApp?.initDataUnsafe?.user?.first_name || 'Игрок'
  };

  // Переписанная функция placeBet()
  async function placeBet() {
    const gamesRef = firebase.ref(db, 'games');
    
    // Ищем открытую игру
    const snapshot = await firebase.get(gamesRef);
    let availableGame = null;

    if (snapshot.exists()) {
      const games = snapshot.val();
      availableGame = Object.keys(games).find(id => 
        games[id].status === 'waiting' && 
        games[id].player1 !== currentPlayer.id
      );
    }

    if (availableGame) {
      // Присоединяемся к игре
      await firebase.set(firebase.ref(db, `games/${availableGame}`), {
        player2: currentPlayer.id,
        status: 'playing'
      });
      startGame(availableGame);
    } else {
      // Создаём новую игру
      const newGameRef = firebase.push(firebase.ref(db, 'games'));
      await firebase.set(newGameRef, {
        player1: currentPlayer.id,
        status: 'waiting'
      });
      listenToGame(newGameRef.key);
    }
  }

  // Слушаем изменения игры
  function listenToGame(gameId) {
    firebase.onValue(firebase.ref(db, `games/${gameId}`), (snapshot) => {
      const game = snapshot.val();
      if (game.status === 'playing' && game.player2) {
        startGame(game); // Ваша существующая функция
      }
    });
  }

  // Вешаем обработчик на кнопку
  document.getElementById('pvp-bet').addEventListener('click', placeBet);
</script>
</body>
</html>