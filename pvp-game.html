<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Gizmo PVP (–ö–æ–º–Ω–∞—Ç—ã)</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/pvp-game.css">
</head>
<body>

<div id="pvp-container">
  <div class="header">
    <h2>üéÆ –ö–æ–º–Ω–∞—Ç—ã PVP</h2>
    <button id="create-room-btn" class="create-btn">+ –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
  </div>
  
  <div id="rooms-list">
    <div class="empty-message">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç</div>
  </div>
  
  <div id="room-details" style="display: none;">
    <h3 id="room-name"></h3>
    <div id="players-list"></div>
    <div id="room-controls">
      <button id="ready-btn" class="ready-btn">–ì–æ—Ç–æ–≤</button>
      <button id="leave-room-btn" class="leave-btn">–ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
    </div>
    <div id="game-status"></div>
  </div>
  
  <div id="version">Build 1.2v (Room System)</div>
</div>

<!-- –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é -->
<div id="panel">
  <div class="tab-buttons">
    <button class="tab-button" onclick="window.location.href='index.html'">–ü—Ä–æ—Ñ–∏–ª—å</button>
    <button class="tab-button" onclick="window.location.href='index.html#shop'">–ú–∞–≥–∞–∑–∏–Ω</button>
    <button class="tab-button active" onclick="window.location.href='pvp-game.html'">PVP</button>
  </div>
</div>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
const firebaseConfig = {
  apiKey: "AIzaSyC6EklCDD25kU_nuXyeh5mj9F24KECyYpM",
  databaseURL: "https://gizmo-27843-default-rtdb.firebaseio.com"
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// –¢–µ–∫—É—â–∏–π –∏–≥—Ä–æ–∫
const currentPlayer = {
  id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id || 'player_' + Math.random().toString(36).slice(2, 9),
  name: window.Telegram?.WebApp?.initDataUnsafe?.user?.first_name || '–ò–≥—Ä–æ–∫',
  ready: false
};

let currentRoomId = null;
let currentRoomRef = null;
let roomsRef = db.ref('rooms');

// –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
const roomsList = document.getElementById('rooms-list');
const roomDetails = document.getElementById('room-details');
const roomName = document.getElementById('room-name');
const playersList = document.getElementById('players-list');
const gameStatus = document.getElementById('game-status');
const createRoomBtn = document.getElementById('create-room-btn');
const readyBtn = document.getElementById('ready-btn');
const leaveRoomBtn = document.getElementById('leave-room-btn');

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
function initPVPRoomSystem() {
  createRoomBtn.addEventListener('click', showCreateRoomModal);
  readyBtn.addEventListener('click', toggleReadyStatus);
  leaveRoomBtn.addEventListener('click', leaveRoom);
  
  loadRooms();
  
  roomsRef.on('value', (snapshot) => {
    updateRoomsList(snapshot);
  }, (error) => {
    console.log("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫–æ–º–Ω–∞—Ç:", error);
  });
}

// –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã
function showCreateRoomModal() {
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="modal-content">
      <h3>–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</h3>
      <div class="form-group">
        <label for="room-name-input">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã:</label>
        <input type="text" id="room-name-input" placeholder="–ú–æ—è –∫–æ–º–Ω–∞—Ç–∞">
      </div>
      <div class="form-group">
        <label for="max-players">–ú–∞–∫—Å. –∏–≥—Ä–æ–∫–æ–≤:</label>
        <select id="max-players">
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
        </select>
      </div>
      <div class="modal-buttons">
        <button id="confirm-create">–°–æ–∑–¥–∞—Ç—å</button>
        <button id="cancel-create">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  document.getElementById('confirm-create').addEventListener('click', () => {
    const name = document.getElementById('room-name-input').value.trim() || '–ú–æ—è –∫–æ–º–Ω–∞—Ç–∞';
    const maxPlayers = parseInt(document.getElementById('max-players').value);
    createRoom(name, maxPlayers);
    modal.remove();
  });
  
  document.getElementById('cancel-create').addEventListener('click', () => {
    modal.remove();
  });
}

// –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É
function createRoom(name, maxPlayers) {
  currentRoomId = roomsRef.push().key;
  currentRoomRef = db.ref(`rooms/${currentRoomId}`);
  
  const roomData = {
    name: name,
    maxPlayers: maxPlayers,
    players: {
      [currentPlayer.id]: {
        name: currentPlayer.name,
        ready: false
      }
    },
    status: 'waiting',
    createdAt: firebase.database.ServerValue.TIMESTAMP
  };
  
  currentRoomRef.set(roomData)
    .then(() => {
      joinRoom(currentRoomId);
    })
    .catch(error => {
      console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã:", error);
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É");
    });
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç
function loadRooms() {
  roomsRef.once('value')
    .then(snapshot => {
      updateRoomsList(snapshot);
    })
    .catch(error => {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–Ω–∞—Ç:", error);
    });
}

// –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç
function updateRoomsList(snapshot) {
  roomsList.innerHTML = '';
  
  if (!snapshot.exists()) {
    roomsList.innerHTML = '<div class="empty-message">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç</div>';
    return;
  }
  
  const rooms = snapshot.val();
  let hasAvailableRooms = false;
  
  Object.entries(rooms).forEach(([roomId, room]) => {
    if (room && room.status === 'waiting' && Object.keys(room.players || {}).length < (room.maxPlayers || 2)) {
      hasAvailableRooms = true;
      const playerCount = Object.keys(room.players || {}).length;
      
      const roomCard = document.createElement('div');
      roomCard.className = 'room-card';
      roomCard.innerHTML = `
        <h3>${room.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h3>
        <p>–ò–≥—Ä–æ–∫–æ–≤: ${playerCount}/${room.maxPlayers || 2}</p>
        <div class="room-meta">
          <span>${formatTime(room.createdAt)}</span>
          <span>${getRoomStatus(room)}</span>
        </div>
      `;
      
      roomCard.addEventListener('click', () => {
        joinRoom(roomId);
      });
      
      roomsList.appendChild(roomCard);
    }
  });
  
  if (!hasAvailableRooms) {
    roomsList.innerHTML = '<div class="empty-message">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç</div>';
  }
}

// –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
function joinRoom(roomId) {
  if (currentRoomId) return;
  
  currentRoomId = roomId;
  currentRoomRef = db.ref(`rooms/${roomId}`);
  
  currentRoomRef.transaction(room => {
    if (!room) return null;
    
    if (Object.keys(room.players || {}).length >= (room.maxPlayers || 2)) {
      alert("–ö–æ–º–Ω–∞—Ç–∞ —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞");
      return;
    }
    
    if (!room.players) {
      room.players = {};
    }
    
    if (!room.players[currentPlayer.id]) {
      room.players[currentPlayer.id] = {
        name: currentPlayer.name,
        ready: false
      };
    }
    
    return room;
  })
  .then(() => {
    setupRoomListeners();
    showRoomDetails();
  })
  .catch(error => {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ:", error);
    currentRoomId = null;
    currentRoomRef = null;
  });
}

// –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–ª—É—à–∞—Ç–µ–ª–∏ –∫–æ–º–Ω–∞—Ç—ã
function setupRoomListeners() {
  currentRoomRef.on('value', snapshot => {
    const room = snapshot.val();
    if (!room) {
      currentRoomId = null;
      currentRoomRef = null;
      hideRoomDetails();
      return;
    }
    
    updateRoomDetails(room);
    
    if (room.status === 'waiting' && allPlayersReady(room)) {
      startGame();
    }
  }, (error) => {
    console.error("Firebase room listener error:", error);
  });
}

// –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –∫–æ–º–Ω–∞—Ç—ã
function showRoomDetails() {
  document.getElementById('pvp-container').querySelector('.header').style.display = 'none';
  roomsList.style.display = 'none';
  roomDetails.style.display = 'block';
}

// –°–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏ –∫–æ–º–Ω–∞—Ç—ã
function hideRoomDetails() {
  document.getElementById('pvp-container').querySelector('.header').style.display = 'flex';
  roomsList.style.display = 'grid';
  roomDetails.style.display = 'none';
}

// –û–±–Ω–æ–≤–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –∫–æ–º–Ω–∞—Ç—ã
function updateRoomDetails(room) {
  roomName.textContent = room.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
  playersList.innerHTML = '';
  
  Object.entries(room.players || {}).forEach(([playerId, player]) => {
    const playerItem = document.createElement('div');
    playerItem.className = 'player-item';
    playerItem.innerHTML = `
      <span>${player.name || '–ò–≥—Ä–æ–∫'} ${playerId === currentPlayer.id ? '(–í—ã)' : ''}</span>
      <span class="player-status ${player.ready ? 'ready-status">‚úì' : 'not-ready-status">‚úó'}</span>
    `;
    playersList.appendChild(playerItem);
  });
  
  if (room.status === 'waiting') {
    gameStatus.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...';
    readyBtn.style.display = 'inline-block';
    readyBtn.textContent = currentPlayer.ready ? '–ù–µ –≥–æ—Ç–æ–≤' : '–ì–æ—Ç–æ–≤';
  } else if (room.status === 'playing') {
    gameStatus.textContent = '–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!';
    readyBtn.style.display = 'none';
  } else if (room.status === 'finished') {
    gameStatus.textContent = '–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
    readyBtn.style.display = 'none';
  }
}

// –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
function toggleReadyStatus() {
  currentPlayer.ready = !currentPlayer.ready;
  
  currentRoomRef.child(`players/${currentPlayer.id}/ready`).set(currentPlayer.ready)
    .then(() => {
      readyBtn.textContent = currentPlayer.ready ? '–ù–µ –≥–æ—Ç–æ–≤' : '–ì–æ—Ç–æ–≤';
    })
    .catch(error => {
      console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:", error);
    });
}

// –í—Å–µ –ª–∏ –∏–≥—Ä–æ–∫–∏ –≥–æ—Ç–æ–≤—ã
function allPlayersReady(room) {
  return Object.values(room.players || {}).every(player => player.ready);
}

// –ù–∞—á–∞—Ç—å –∏–≥—Ä—É
function startGame() {
  currentRoomRef.update({ status: 'playing' })
    .then(() => {
      setTimeout(() => {
        finishGame();
      }, 3000);
    })
    .catch(error => {
      console.error("–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã:", error);
    });
}

// –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É
function finishGame() {
  currentRoomRef.once('value')
    .then(snapshot => {
      const room = snapshot.val();
      if (!room) return;
      
      const players = Object.keys(room.players || {});
      if (players.length === 0) return;
      
      const winnerId = players[Math.floor(Math.random() * players.length)];
      
      return currentRoomRef.update({
        status: 'finished',
        winner: winnerId,
        finishedAt: firebase.database.ServerValue.TIMESTAMP
      });
    })
    .catch(error => {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä—ã:", error);
    });
}

// –ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É
function leaveRoom() {
  if (!currentRoomId) return;
  
  currentRoomRef.child(`players/${currentPlayer.id}`).remove()
    .then(() => {
      currentRoomRef.once('value')
        .then(snapshot => {
          const room = snapshot.val();
          if (room && Object.keys(room.players || {}).length === 0) {
            currentRoomRef.remove();
          }
        });
      
      currentRoomId = null;
      currentRoomRef = null;
      currentPlayer.ready = false;
      hideRoomDetails();
    })
    .catch(error => {
      console.error("–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã:", error);
    });
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function formatTime(timestamp) {
  if (!timestamp) return '';
  const date = new Date(timestamp);
  return date.toLocaleTimeString();
}

function getRoomStatus(room) {
  if (!room) return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
  if (room.status === 'playing') return '–ò–≥—Ä–∞ –∏–¥–µ—Ç';
  if (room.status === 'finished') return '–ó–∞–≤–µ—Ä—à–µ–Ω–∞';
  return '–û–∂–∏–¥–∞–Ω–∏–µ';
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', initPVPRoomSystem);
</script>
</body>
</html>