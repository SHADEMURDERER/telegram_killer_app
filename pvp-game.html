<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Gizmo PVP</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <link rel="stylesheet" href="styles/main.css">
  <link rel="stylesheet" href="styles/pvp-game.css">
</head>
<body>
<div id="pvp-container">
  <div class="header">
    <h2>üéÆ PVP –†—É–ª–µ—Ç–∫–∞</h2>
  </div>
  
  <div id="roulette-container">
    <div id="roulette-arrow"></div>
    <div id="roulette-track">
      <div id="roulette-slots-wrapper">
        <div id="roulette-slots"></div>
      </div>
    </div>
    <div id="winner-display"></div>
    <div id="bet-controls">
      <button id="place-bet-btn" class="bet-btn">–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É</button>
      <div id="timer-display" style="display: none;">–û—Å—Ç–∞–ª–æ—Å—å: <span id="time-left">30</span>—Å</div>
    </div>
  </div>
  
  <div id="version">Build 4.4v (Fixed)</div>
</div>

<div id="panel">
  <div class="tab-buttons">
    <button class="tab-button" onclick="window.location.href='index.html'">–ü—Ä–æ—Ñ–∏–ª—å</button>
    <button class="tab-button" onclick="window.location.href='index.html#shop'">–ú–∞–≥–∞–∑–∏–Ω</button>
    <button class="tab-button active" onclick="window.location.href='pvp-game.html'">PVP</button>
  </div>
</div>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
const firebaseConfig = {
  apiKey: "AIzaSyC6EklCDD25kU_nuXyeh5mj9F24KECyYpM",
  databaseURL: "https://gizmo-27843-default-rtdb.firebaseio.com",
  projectId: "gizmo-27843"
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
let app;
try {
  app = firebase.getApp();
} catch (e) {
  app = firebase.initializeApp(firebaseConfig);
}
const db = firebase.database();

// –¢–µ–∫—É—â–∏–π –∏–≥—Ä–æ–∫
const currentPlayer = {
  id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id || 'player_' + Math.random().toString(36).slice(2, 9),
  name: window.Telegram?.WebApp?.initDataUnsafe?.user?.first_name || '–ò–≥—Ä–æ–∫'
};

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
const gameState = {
  colors: ['#FF5252', '#4CAF50', '#2196F3', '#FFC107', '#9C27B0', '#00BCD4'],
  slotWidth: 0,
  serverTimeOffset: 0,
  isPlacingBet: false,
  currentRoom: null
};

// –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
const rouletteSlots = document.getElementById('roulette-slots');
const rouletteSlotsWrapper = document.getElementById('roulette-slots-wrapper');
const winnerDisplay = document.getElementById('winner-display');
const placeBetBtn = document.getElementById('place-bet-btn');
const timerDisplay = document.getElementById('timer-display');
const timeLeftSpan = document.getElementById('time-left');

// –°—Å—ã–ª–∫–∏ Firebase
const roomRef = db.ref('pvpRoulette/room');
const serverTimeRef = db.ref('.info/serverTimeOffset');

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
function initRouletteGame() {
  // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
  serverTimeRef.on('value', (snap) => {
    gameState.serverTimeOffset = snap.val() || 0;
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫—É —Å—Ç–∞–≤–∫–∏
  placeBetBtn.addEventListener('click', () => {
    if (!gameState.isPlacingBet) {
      gameState.isPlacingBet = true;
      placeBet().finally(() => {
        gameState.isPlacingBet = false;
      });
    }
  });

  // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–º–Ω–∞—Ç–µ
  roomRef.on('value', (snapshot) => {
    try {
      const room = snapshot.val();
      if (room) {
        gameState.currentRoom = room;
        updateGameUI(room);
      } else {
        resetRoom();
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–Ω–∞—Ç—ã:', error);
    }
  }, (error) => {
    console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã:', error);
  });
}

// –°–æ–∑–¥–∞–Ω–∏–µ/—Å–±—Ä–æ—Å –∫–æ–º–Ω–∞—Ç—ã
function resetRoom() {
  const roomData = {
    status: 'waiting',
    players: {},
    startTime: null,
    winner: null,
    lastReset: getServerTime()
  };

  return roomRef.set(roomData).catch(error => {
    console.error('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –∫–æ–º–Ω–∞—Ç—ã:', error);
  });
}

// –†–∞–∑–º–µ—â–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏
async function placeBet() {
  try {
    const room = gameState.currentRoom;
    if (!room) {
      await resetRoom();
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–º–Ω–∞—Ç—ã
    if (room.status !== 'waiting' && room.status !== 'betting') {
      alert('–°—Ç–∞–≤–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–∫—Ä—ã—Ç—ã');
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–¥–µ–ª–∞–ª –ª–∏ —É–∂–µ –∏–≥—Ä–æ–∫ —Å—Ç–∞–≤–∫—É
    if (room.players && room.players[currentPlayer.id]) {
      alert('–í—ã —É–∂–µ —Å–¥–µ–ª–∞–ª–∏ —Å—Ç–∞–≤–∫—É');
      return;
    }

    // –í—ã–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç
    const usedColors = room.players ? Object.values(room.players).map(p => p?.color).filter(Boolean) : [];
    let availableColors = gameState.colors.filter(c => !usedColors.includes(c));
    if (availableColors.length === 0) {
      availableColors = gameState.colors;
    }

    const randomColor = availableColors[Math.floor(Math.random() * availableColors.length)];

    // –î–æ–±–∞–≤–ª—è–µ–º –∏–≥—Ä–æ–∫–∞ –≤ –∫–æ–º–Ω–∞—Ç—É
    const playerData = {
      name: currentPlayer.name,
      color: randomColor,
      betTime: getServerTime()
    };

    await roomRef.child('players').child(currentPlayer.id).set(playerData);

    // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫–æ–≤ —Å—Ç–∞–ª–æ 2+, –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
    const playerCount = room.players ? Object.keys(room.players).length + 1 : 1;
    if (playerCount >= 2 && room.status === 'waiting') {
      await startBettingTimer();
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Å—Ç–∞–≤–∫–∏:', error);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏ —Å—Ç–∞–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
    throw error;
  }
}

// –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞ —Å—Ç–∞–≤–æ–∫
function startBettingTimer() {
  return roomRef.update({
    status: 'betting',
    startTime: getServerTime()
  }).catch(error => {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ç–∞–π–º–µ—Ä–∞:', error);
    throw error;
  });
}

// –ó–∞–ø—É—Å–∫ —Ä—É–ª–µ—Ç–∫–∏
function startRoulette(room) {
  const activePlayers = room.players ? Object.entries(room.players).filter(([_, p]) => p?.color) : [];
  if (activePlayers.length < 2) {
    return resetRoom();
  }

  return roomRef.update({
    status: 'spinning'
  }).then(() => {
    const spinDuration = 3000 + Math.random() * 4000;
    const winnerIndex = Math.floor(Math.random() * activePlayers.length);
    const winnerId = activePlayers[winnerIndex][0];
    const winnerPlayer = activePlayers[winnerIndex][1];

    // –ê–Ω–∏–º–∞—Ü–∏—è —Ä—É–ª–µ—Ç–∫–∏
    gameState.slotWidth = 100 / activePlayers.length;
    return animateRoulette(winnerIndex, spinDuration).then(() => {
      // –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –æ–±—ä—è–≤–ª—è–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
      return roomRef.update({
        status: 'finished',
        winner: {
          id: winnerId,
          name: winnerPlayer.name,
          color: winnerPlayer.color
        },
        finishTime: getServerTime()
      }).then(() => {
        // –ß–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–æ–º–Ω–∞—Ç—É
        setTimeout(resetRoom, 10000);
      });
    });
  });
}

// –ê–Ω–∏–º–∞—Ü–∏—è —Ä—É–ª–µ—Ç–∫–∏
function animateRoulette(winnerIndex, duration) {
  return new Promise((resolve) => {
    const targetPosition = 100 - (winnerIndex * gameState.slotWidth);
    
    rouletteSlotsWrapper.style.transition = 'none';
    rouletteSlotsWrapper.style.transform = 'translateX(0)';
    
    setTimeout(() => {
      rouletteSlotsWrapper.style.transition = `transform ${duration/1000}s cubic-bezier(0.2, 0.1, 0.2, 1)`;
      rouletteSlotsWrapper.style.transform = `translateX(-${targetPosition}%)`;
      
      setTimeout(resolve, duration);
    }, 10);
  });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã
function updateGameUI(room) {
  try {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏–≥—Ä—ã
    switch (room.status) {
      case 'waiting':
        placeBetBtn.disabled = false;
        placeBetBtn.textContent = '–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É';
        timerDisplay.style.display = 'none';
        winnerDisplay.textContent = '';
        break;
        
      case 'betting':
        placeBetBtn.disabled = !!(room.players && room.players[currentPlayer.id]);
        placeBetBtn.textContent = (room.players && room.players[currentPlayer.id]) 
          ? '–í—ã —É–∂–µ —Å–¥–µ–ª–∞–ª–∏ —Å—Ç–∞–≤–∫—É' 
          : '–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä
        if (room.startTime) {
          const elapsed = Math.floor((getServerTime() - room.startTime) / 1000);
          const timeLeft = Math.max(0, 30 - elapsed);
          timeLeftSpan.textContent = timeLeft;
          timerDisplay.style.display = 'block';
          
          if (timeLeft <= 0 && room.players && Object.keys(room.players).length >= 2) {
            startRoulette(room);
          }
        }
        break;
        
      case 'spinning':
        placeBetBtn.disabled = true;
        timerDisplay.style.display = 'none';
        break;
        
      case 'finished':
        showWinner(room.winner);
        placeBetBtn.disabled = true;
        timerDisplay.style.display = 'none';
        break;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä—É–ª–µ—Ç–∫–∏
    updateRouletteDisplay(room);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:', error);
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä—É–ª–µ—Ç–∫–∏
function updateRouletteDisplay(room) {
  try {
    rouletteSlots.innerHTML = '';
    
    if (!room.players) return;
    
    const activePlayers = Object.values(room.players).filter(p => p?.color);
    const totalPlayers = activePlayers.length;
    
    if (totalPlayers === 0) return;
    
    gameState.slotWidth = 100 / totalPlayers;
    
    activePlayers.forEach((player, index) => {
      if (player && player.color) {
        createSlot(player, index, totalPlayers);
        if (index === 0) createSlot(player, -1, totalPlayers); // –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏
      }
    });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä—É–ª–µ—Ç–∫–∏:', error);
  }
}

// –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ—Ç–∞
function createSlot(player, index, totalPlayers) {
  try {
    const slot = document.createElement('div');
    slot.className = 'roulette-slot';
    slot.style.backgroundColor = player.color;
    slot.style.width = `${gameState.slotWidth}%`;
    slot.style.left = `${index * gameState.slotWidth}%`;
    
    const percent = document.createElement('div');
    percent.className = 'slot-percent';
    percent.textContent = `${Math.round(100 / totalPlayers)}%`;
    percent.style.color = getContrastColor(player.color);
    
    slot.appendChild(percent);
    rouletteSlots.appendChild(slot);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–æ—Ç–∞:', error);
  }
}

// –ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞
function getContrastColor(hexColor) {
  if (!hexColor || typeof hexColor !== 'string' || hexColor.length < 7) return '#FFFFFF';
  
  try {
    const r = parseInt(hexColor.substring(1, 3), 16);
    const g = parseInt(hexColor.substring(3, 5), 16);
    const b = parseInt(hexColor.substring(5, 7), 16);
    const brightness = (r * 299 + g * 587 + b * 114) / 1000;
    return brightness > 128 ? '#000000' : '#FFFFFF';
  } catch (e) {
    return '#FFFFFF';
  }
}

// –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
function showWinner(winner) {
  try {
    if (winner) {
      winnerDisplay.innerHTML = `
        <div class="winner-box" style="background-color: ${winner.color || '#7f5af0'}">
          –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${winner.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏–≥—Ä–æ–∫'}!
        </div>
      `;
    } else {
      winnerDisplay.textContent = '';
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è:', error);
  }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
function getServerTime() {
  return Date.now() + gameState.serverTimeOffset;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', initRouletteGame);
</script>
</body>
</html>