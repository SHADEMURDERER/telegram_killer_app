<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Gizmo PVP</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    /* Стили остаются без изменений */
  </style>
</head>
<body>

<div id="pvp-container">
  <!-- Интерфейс без изменений -->
  <div id="version">Build 0.2v (fixed matchmaking)</div>
</div>

<script>
// 1. Инициализация
const firebaseConfig = {
  apiKey: "AIzaSyC6EklCDD25kU_nuXyeh5mj9F24KECyYpM",
  databaseURL: "https://gizmo-27843-default-rtdb.firebaseio.com"
};

const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// 2. Глобальные переменные
let currentGameId = null;
const currentPlayer = {
  id: 'player_' + Math.random().toString(36).slice(2, 9),
  name: 'Игрок'
};

// 3. Поиск активных игр
async function findOpenGame() {
  const snapshot = await db.ref('games').orderByChild('status').equalTo('waiting').once('value');
  const games = snapshot.val() || {};
  
  for (const [gameId, game] of Object.entries(games)) {
    if (game.player1.id !== currentPlayer.id) {
      return { gameId, game };
    }
  }
  return null;
}

// 4. Основной обработчик
document.getElementById('action-button').addEventListener('click', async () => {
  const button = document.getElementById('action-button');
  button.disabled = true;
  
  try {
    // Поиск существующей игры
    const openGame = await findOpenGame();
    
    if (openGame) {
      // Присоединяемся к игре
      await db.ref(`games/${openGame.gameId}`).update({
        player2: currentPlayer,
        status: 'playing'
      });
      currentGameId = openGame.gameId;
      startGame();
    } else {
      // Создаём новую игру
      const newGameRef = db.ref('games').push();
      currentGameId = newGameRef.key;
      await newGameRef.set({
        player1: currentPlayer,
        status: 'waiting',
        createdAt: Date.now()
      });
      waitForOpponent();
    }
  } catch (error) {
    console.error("Matchmaking error:", error);
    button.disabled = false;
  }
});

// 5. Логика игры
function waitForOpponent() {
  db.ref(`games/${currentGameId}`).on('value', (snapshot) => {
    const game = snapshot.val();
    if (game?.status === 'playing') {
      startGame();
    }
  });
}

function startGame() {
  db.ref(`games/${currentGameId}`).update({ status: 'started' });
  
  // Симуляция боя
  setTimeout(() => {
    const winner = Math.random() > 0.5 ? 'player1' : 'player2';
    db.ref(`games/${currentGameId}`).update({ 
      status: 'finished',
      winner
    });
    showResult(winner);
  }, 3000);
}

function showResult(winner) {
  // Обновляем интерфейс
}
</script>
</body>
</html>