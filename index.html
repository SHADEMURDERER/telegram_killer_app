<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Gizmo Wheel</title>
  <style>
    body {
      margin: 0;
      background: #1e1e2e;
      color: white;
      font-family: 'Arial', sans-serif;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    #wheel-container {
      position: relative;
      width: 400px;
      height: 400px;
      margin: 20px auto;
    }

    #wheel {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      position: relative;
      overflow: hidden;
      transition: transform 5s cubic-bezier(0.17, 0.67, 0.12, 0.99);
      transform: rotate(0deg);
      border: 8px solid #2a2826;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }

    .wheel-section {
      position: absolute;
      width: 50%;
      height: 50%;
      transform-origin: bottom right;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
      box-sizing: border-box;
      padding-bottom: 40%;
      padding-left: 10%;
    }

    #timer {
      font-size: 3rem;
      font-weight: bold;
      margin: 20px 0;
      height: 60px;
    }

    #bet-controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 20px;
    }

    #bet-amount {
      width: 200px;
      margin-bottom: 10px;
      background: rgba(58, 56, 54, 0.7);
      border: 1px solid #3a3836;
      border-radius: 8px;
      padding: 10px;
      color: white;
      font-size: 1.2rem;
      text-align: center;
    }

    #place-bet {
      background: #7f5af0;
      border: none;
      border-radius: 8px;
      padding: 12px 25px;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    #place-bet:hover {
      background: #6a4ac9;
    }

    #place-bet:disabled {
      background: #3a3836;
      cursor: not-allowed;
    }

    #players {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }

    .player {
      background: rgba(42, 40, 38, 0.8);
      border-radius: 10px;
      padding: 15px;
      min-width: 150px;
      text-align: center;
      border: 1px solid #3a3836;
    }

    .player-color {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 10px;
    }

    #current-bets {
      margin-top: 20px;
      text-align: center;
    }

    #total-pot {
      font-size: 1.5rem;
      font-weight: bold;
      margin-top: 10px;
      color: #f8d56b;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
</head>
<body>
  <div id="wheel-container">
    <div id="wheel"></div>
  </div>

  <div id="timer"></div>

  <div id="current-bets">
    <h3>Текущие ставки</h3>
    <div id="bets-list"></div>
    <div id="total-pot">Общий банк: 0 монет</div>
  </div>

  <div id="bet-controls">
    <input type="number" id="bet-amount" min="1" max="100" placeholder="Количество монет">
    <button id="place-bet">Сделать ставку</button>
  </div>

  <div id="players">
    <div class="player">
      <h3>Ваш баланс</h3>
      <div id="your-balance">100 монет</div>
    </div>
    <div class="player">
      <h3>Другие игроки</h3>
      <div id="other-players">Ожидание игроков...</div>
    </div>
  </div>

  <script>
    // Конфигурация Firebase (ЗАМЕНИТЕ НА СВОЮ!)
    const firebaseConfig = {
      apiKey: "AIzaSyВашКлюч",
      authDomain: "ваш-проект.firebaseapp.com",
      databaseURL: "https://ваш-проект.firebaseio.com",
      projectId: "ваш-проект",
      storageBucket: "ваш-проект.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abcdef123456"
    };

    // Инициализация Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Данные игрока
    const currentPlayer = {
      id: '',
      name: 'Гость',
      balance: 100,
      color: getRandomColor(),
      bet: 0
    };

    // Состояние игры
    let gameState = {
      players: {},
      totalPot: 0,
      countdown: null,
      isSpinning: false,
      winner: null
    };

    // DOM элементы
    const wheel = document.getElementById('wheel');
    const timer = document.getElementById('timer');
    const betAmountInput = document.getElementById('bet-amount');
    const placeBetBtn = document.getElementById('place-bet');
    const yourBalance = document.getElementById('your-balance');
    const otherPlayers = document.getElementById('other-players');
    const betsList = document.getElementById('bets-list');
    const totalPot = document.getElementById('total-pot');

    // Инициализация при загрузке
    document.addEventListener('DOMContentLoaded', () => {
      initPlayer();
      initGame();
      setupEventListeners();
    });

    function initPlayer() {
      // Генерируем уникальный ID для игрока
      currentPlayer.id = generatePlayerId();
      
      // Если это Telegram WebApp, используем данные пользователя
      if (window.Telegram && Telegram.WebApp) {
        const tgUser = Telegram.WebApp.initDataUnsafe.user;
        if (tgUser) {
          currentPlayer.name = tgUser.first_name || 'Telegram User';
        }
        Telegram.WebApp.expand();
      } else {
        currentPlayer.name = prompt('Введите ваше имя:', 'Игрок') || 'Игрок';
      }
      
      updatePlayerUI();
    }

    function initGame() {
      // Слушаем изменения состояния игры
      database.ref('game').on('value', (snapshot) => {
        gameState = snapshot.val() || gameState;
        updateGameUI();
        
        // Если начался обратный отсчет
        if (gameState.countdown !== null && !gameState.isSpinning) {
          startCountdown();
        }
        
        // Если колесо должно крутиться
        if (gameState.isSpinning && !wheel.classList.contains('spinning')) {
          spinWheel();
        }
      });
    }

    function setupEventListeners() {
      placeBetBtn.addEventListener('click', placeBet);
      
      betAmountInput.addEventListener('input', () => {
        const maxBet = Math.min(currentPlayer.balance, 100);
        if (parseInt(betAmountInput.value) > maxBet) {
          betAmountInput.value = maxBet;
        }
      });
    }

    function placeBet() {
      const amount = parseInt(betAmountInput.value);
      
      if (isNaN(amount)) {
        alert('Введите корректное количество монет!');
        return;
      }
      
      if (amount < 1) {
        alert('Минимальная ставка - 1 монета!');
        return;
      }
      
      if (amount > currentPlayer.balance) {
        alert('Недостаточно монет!');
        return;
      }
      
      if (gameState.players[currentPlayer.id]) {
        alert('Вы уже сделали ставку в этом раунде!');
        return;
      }
      
      // Обновляем баланс игрока
      currentPlayer.balance -= amount;
      currentPlayer.bet = amount;
      updatePlayerUI();
      
      // Добавляем игрока в игру
      const playerData = {
        name: currentPlayer.name,
        color: currentPlayer.color,
        bet: amount,
        timestamp: Date.now()
      };
      
      database.ref('game/players/' + currentPlayer.id).set(playerData);
      
      // Обновляем общий банк
      database.ref('game/totalPot').transaction((pot) => {
        return (pot || 0) + amount;
      });
      
      betAmountInput.value = '';
      placeBetBtn.disabled = true;
      
      // Если игроков достаточно, начинаем обратный отсчет
      if (Object.keys(gameState.players).length >= 1) {
        database.ref('game/countdown').set(5);
      }
    }

    function startCountdown() {
      let countdown = gameState.countdown;
      timer.textContent = countdown;
      
      const countdownInterval = setInterval(() => {
        countdown--;
        timer.textContent = countdown;
        
        if (countdown <= 0) {
          clearInterval(countdownInterval);
          database.ref('game/isSpinning').set(true);
        }
      }, 1000);
    }

    function spinWheel() {
      // Рассчитываем углы для каждого игрока
      const players = Object.values(gameState.players);
      const totalBet = players.reduce((sum, player) => sum + player.bet, 0);
      
      let lastAngle = 0;
      players.forEach(player => {
        const angle = (player.bet / totalBet) * 360;
        createWheelSection(player.color, lastAngle, lastAngle + angle);
        lastAngle += angle;
      });
      
      // Выбираем случайный угол для остановки
      const spinAngle = 3600 + Math.random() * 360; // 10 полных оборотов + случайный угол
      wheel.style.transform = `rotate(${-spinAngle}deg)`;
      
      // Через 5 секунд определяем победителя
      setTimeout(() => {
        const winningAngle = spinAngle % 360;
        determineWinner(winningAngle, players, totalBet);
      }, 5000);
    }

    function determineWinner(winningAngle, players, totalBet) {
      let currentAngle = 0;
      let winner = null;
      
      players.forEach(player => {
        const angle = (player.bet / totalBet) * 360;
        if (winningAngle >= currentAngle && winningAngle < currentAngle + angle) {
          winner = player;
        }
        currentAngle += angle;
      });
      
      // Обновляем состояние игры
      database.ref('game').update({
        winner: winner,
        isSpinning: false,
        countdown: null
      });
      
      // Сбрасываем игроков и банк через 5 секунд
      setTimeout(() => {
        database.ref('game/players').remove();
        database.ref('game/totalPot').set(0);
        database.ref('game/winner').remove();
        
        // Возвращаем кнопку ставки
        placeBetBtn.disabled = false;
      }, 5000);
    }

    function createWheelSection(color, startAngle, endAngle) {
      const section = document.createElement('div');
      section.className = 'wheel-section';
      section.style.backgroundColor = color;
      section.style.transform = `rotate(${startAngle}deg)`;
      section.style.clipPath = `polygon(0 0, 100% 0, 100% 100%)`;
      
      const percentage = Math.round(((endAngle - startAngle) / 360) * 100);
      section.textContent = `${percentage}%`;
      
      wheel.appendChild(section);
    }

    function updateGameUI() {
      // Обновляем список ставок
      betsList.innerHTML = '';
      Object.values(gameState.players).forEach(player => {
        const betItem = document.createElement('div');
        betItem.innerHTML = `<span style="color:${player.color}">${player.name}</span>: ${player.bet} монет`;
        betsList.appendChild(betItem);
      });
      
      // Обновляем общий банк
      totalPot.textContent = `Общий банк: ${gameState.totalPot || 0} монет`;
      
      // Обновляем список других игроков
      const otherPlayersList = Object.entries(gameState.players)
        .filter(([id]) => id !== currentPlayer.id)
        .map(([_, player]) => player);
      
      if (otherPlayersList.length > 0) {
        otherPlayers.innerHTML = otherPlayersList
          .map(player => `<div><span class="player-color" style="background:${player.color}"></span>${player.name}: ${player.bet} монет</div>`)
          .join('');
      } else {
        otherPlayers.textContent = 'Ожидание игроков...';
      }
      
      // Если игра уже идет, блокируем кнопку ставки
      if (gameState.countdown !== null || gameState.isSpinning || gameState.players[currentPlayer.id]) {
        placeBetBtn.disabled = true;
      } else {
        placeBetBtn.disabled = false;
      }
      
      // Показываем победителя
      if (gameState.winner) {
        timer.textContent = `Победитель: ${gameState.winner.name}`;
        
        // Если это текущий игрок, обновляем баланс
        if (gameState.winner.id === currentPlayer.id) {
          currentPlayer.balance += gameState.totalPot;
          updatePlayerUI();
        }
      }
    }

    function updatePlayerUI() {
      yourBalance.textContent = `${currentPlayer.balance} монет`;
      betAmountInput.max = Math.min(currentPlayer.balance, 100);
    }

    // Вспомогательные функции
    function generatePlayerId() {
      return 'player_' + Math.random().toString(36).substr(2, 9);
    }

    function getRandomColor() {
      const colors = [
        '#FF5252', '#FF4081', '#E040FB', '#7C4DFF', 
        '#536DFE', '#448AFF', '#40C4FF', '#18FFFF', 
        '#64FFDA', '#69F0AE', '#B2FF59', '#EEFF41', 
        '#FFFF00', '#FFD740', '#FFAB40', '#FF6E40'
      ];
      return colors[Math.floor(Math.random() * colors.length)];
    }
  </script>
</body>
</html>